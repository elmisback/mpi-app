<canvas id="mpi-canvas" style="width:100%; height:100%">
<script>

// Global variables.
  var step = 0;
  var fps = 1024;  // Frames per step (one step per event).
  var steps_shown = 95;  // Intervals shown on the screen.
  var frames_shown = fps * steps_shown;
  var data = new Float32Array(frames_shown);
  data.fill(0);

// Helper functions.
  var get_peaks = function(data) {
    // return indices of peaks
    var peaks = [];
    for (var i=0; i < data.length; i++) {
      if (i > 0 && i < data.length - 1 &&
          Math.abs(data[i]) > Math.abs(data[i-1]) &&
          Math.abs(data[i]) > Math.abs(data[i+1])) {
        peaks.push(i);
      }
    }
    return peaks;
  };

  var interval_color = function(interval) {
    return "Red";
  };

  var paint_intervals = function(intervals) {
    var canvas = document.getElementById("mpi-canvas");
    var ctx = canvas.getContext("2d");
    for (var i=0; i < intervals.length; i++) {
      x1 = canvas.width/frames_shown * intervals[i][0];
      x2 = canvas.width/frames_shown * intervals[i][1];
      ctx.fillStyle = interval_color(intervals[i]);
      ctx.fillRect(x1, 0, x2 - x1, canvas.height);
      ctx.stroke();
    }
  };

  var phonation_density = function(data) {
    // Yields an array with the density of above-threshold frames.
    var N = 900;  // above-threshold per this many frames.
    var threshold = .03;
    var density = new Array(data.length);
    density.fill(0);

    // NOTE could maybe do this in one pass.

    // Are data entries above threshold?
    var above = new Array(data.length);
    for (var i=0; i < data.length; i++) {
      above[i] = (Math.abs(data[i]) > threshold) ? 1 : 0;
    }

    for (var i=0; i < N; i++) { // get first unit density.
      density[0] += above[i];
    }

    for (var i=N; i < data.length; i++) {
      density[i - N + 1] = density[i - N] + above[i] - above[i - N];
    }
    console.log(density);
    return density;
  };

  var phonation_intervals = function(data) {
    // finds phonation intervals in data based on a threshold
    var density = phonation_density(data);
    console.log(density);
    var intervals = [];
    var curr = null;
    var min_density = 20;
    for (var i=0; i < density.length; i++) {
      var v = density[i];
      if ((!curr) && (v > min_density)) {
          curr = [i, null];
      } else if (curr && (v < min_density)) {
          curr[1] = i - 1;
          intervals.push(curr.slice(0));
          curr = null;
      }
    }
    //console.log(intervals);
    //console.log(intervals.length);
    return intervals;
  }

  var graph = function(data) {
    var canvas = document.getElementById("mpi-canvas");
    // TODO figure out how to scale properly.
    canvas.width=700;
    canvas.height=700;
    var ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    var intervals = phonation_intervals(data);
    paint_intervals(intervals);
    ctx.fillStyle= "black";
    var gain = 800;
    // NOTE We're still only plotting peaks
    var peaks = get_peaks(data);
    for (var i=0; i < peaks.length; i++) {
      var j = peaks[i];
      var h = canvas.height - Math.abs(data[j] * gain);
      var w = j * (canvas.width / data.length);
      ctx.fillRect(w, h, 1, h);
    }
    ctx.stroke();  // Draw it
  };


// Initialization function.
  var handleSuccess = function(stream) {
    var context = new AudioContext();
    var input = context.createMediaStreamSource(stream)
    var processor = context.createScriptProcessor(fps,1,1);
    var filter = context.createBiquadFilter();
    input.connect(filter);
    filter.connect(processor);
    filter.type = "lowpass";
    filter.frequency = 440;

    console.log(context);
    processor.connect(context.destination);
    processor.onaudioprocess = process_audio;
  };

// Main loop.
  var process_audio = function(e) {
    samples = e.inputBuffer.getChannelData(0);
    //console.log(samples);
    var i = (steps_shown - 1) * fps;
    data.set(data.subarray(fps));
    data.set(samples, i);
    //data = data.slice(fps).concat(Array.prototype.slice.call(samples));
    graph(data);
  };

// Get audio permission and start graphing!
  navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(handleSuccess);
</script>
